文本处理利器awk命令
=================================

awk特别适合处理文本化的数据，它不仅仅是简单的字符串匹配，而是包含了变量、函数、表达式、以及流程控制等一系列的功能。

## 1.awk入门

### 1.awk的功能

awk的名称来源与其三位开发者的名字缩写，分别是：Alfred Aho、Peter Jay Weinberger、Brain Wilson Kernighan。

目前，在大部分的Linux反行版中，默认安装的是gawk，即GNU awk，同时兼容POSIX和GNU。

awk是Linux以及UNIX环境下**现有的**功能**最强大**的数据处理工具。

在许多Linux发行版中，/bin/awk命令是/bin/gawk命令的符号链接。

### 2.awk命令的基本语法

基本语法如下：

    awk pattern {actions}

以上语法表示当某个文本行符合pattern指定的匹配规则时，执行actions所执行的操作。

pattern和actions都是可选的，但是它们至少要有一个。

如果省略pattern，则对所有的文本行执行actions；如果省略actions，则将匹配成功的文本行输出到屏幕。

**Note**：actions前面的大括号必须与pattern位于同一行中。

awk命令的操作由一个或者多个命令、函数或者表达式组成，通常情况下，有一下4中操作：

* 变量或者数组赋值
* 输出命令，例如printf或者print
* 内置函数
* 流程控制语句，例如if，while或者for等

### 3.awk的工作流程

1. 自动从指定的数据文件章读取行文本
2. 自动更新awk的内置系统变量的值
3. 依次执行程序中所有的匹配模式及其操作
4. 当执行完程序中所有的匹配模式及其操作之后，如果数据文件中仍然有未读取的数据行，则返回到第（1）步，重复执行。

### 4.执行awk程序的几种方式

与sed相似，用户可以通过3种方式来执行awk程序,分别是：
* 命令行
* awk脚本
* 可执行文件

#### 1.通过命令行执行awk程序

用户可以像执行其他Shell命令一样来执行awk程序，语法如下：

    awk 'program-text' datafile

program-text表示要执行的awk程序语句，**必须**使用**单引号**将其引用起来。

例如：

    awk '{print}' scores.txt

#### 2.执行awk脚本

在awk程序语句比较多的情况下，用户可以将所有的语句写在一个脚本文件中，然后通过awk命令来解释并执行其中的语句。

语法如下：

    awk -f program-file file…

awk命令中**不能**含有除awk语句之外的其他命令或者语句。

#### 3.可执行脚本文件

用户可以通过类似与Shell脚本的方式来执行awk程序，需要在awk程序中指定命令解释器，并且赋予脚本文件的可执行权限。

脚本文件的第一行用来指定命令解释器：

    #! /usr/bin/awk -f

用户可以通过以下命令来执行awk程序：

    awk-script file

awk-script是awk脚本文件的名称，file为要处理的文本数据行。

**一个坑**：在ubuntu中，awk解释器的所在的目录是：

    /usr/bin/awk

## 2.awk的模式匹配

awk中的匹配模式主要包括关系表达式、正则表达式、混合模式、BEGIN模式，以及END模式等。

### 1.关系表达式

awk允许用户使用关系表达式作为匹配模式，当某个文本行满足关系表达式时，就会执行相应的操作。

### 2.正则表达式

awk支持以正则表达式作为匹配模式，用户需要将正则表达式放在两条斜线之间，基本语法为：

    /regular_expression/

### 3.混合模式

awk还支持使用逻辑运算符&&、||、或者！将多个表达式组合起来作为一个模式。

### 4.区间模式

通过模式可以匹配一段连续的文本行。

基本语法如下：

    pattern1,pattern2

pattern可以是关系表达式、正则表达式还可以是混合形式。

### 5.BEGIN模式

BEGIN模式是一种特殊的内置模式，其成立的时机为awk程序刚开始执行但是又没有读取任何数据之前。

用户可以将与数据文件无关，而且在整个程序的生命周期中，只需执行一次的代码放在BEGIN模式对应的操作中。 
通常情况下，用户可以将一些初始化的操作放在BEGIN模式的操作中，例如自定义的列分隔符、行分隔符、以及初始化变量等。

**Note**：对于只包含BEGIN模式的awk程序，awk不会打开任何数据文件。

### 6.END模式

END模式也是一种特殊的内置模式，其成立的时机为awk程序处理完所有的数据，即将退出程序时。在整个生命周期中，END模式只被执行一次。

一般情况下，用户可以将许多善后工作放在END模式对应的操作中。

## 3.变量

### 1.变量的定义和引用

变量是用来存储数据的，其由变量名和变量值组成，其中变量名是用来实现变量值的引用的途径。

在awk中定义变量的方法非常简单，只要给出一个变量名并且赋予适当的值即可，awk中的变量分为两种类型：

* 字符串
* 数值

在定义awk变量时，无需指定变量类型，awk会根据变量所处的环境自动判断。如果没有变量值，则字符串变量默认值是空串，而数值型变量默认值是0。

### 2.系统内置变量

与关系型数据库对应，awk所要处理的文件也是由许多记录（record）组成。

**记录**，就是用来描述某个具体事物的各个方面的。记录是由多个**字段**（field）组合的，每个字段描述某个事物的一个具体的方面。

尽管awk是逐行读取数据的，但是在处理数据时却是以记录为单位的，在某些情况下，记录可以跨越多行。

常用的awk系统变量
|变量|说明|
|----|----|
|$0|记录变量，表示当前正在处理的记录|
|$n|字段变量，n为整数，表示第n个字段的值|
|NF|整数值，表示当前记录($0)的字段数|
|NR|整数值，表示awk已经读入的记录数|
|FILENAM|表示正在处理的数据文件的名称|
|FS|字段分隔符，默认值是空格或者制表符|
|RS|记录分隔符，默认值是换行符|

awk会在读取数据行之前，通过FS和RS确定记录和字段的分隔符，然后进行记录和字段的分隔，每读取一条记录之后，变量$0以及$1、$2等变量会自动更新。

### 3.记录分隔符和字段分隔符

记录分隔符使用**系统变量**RS来指定，如果没有指定，就默认为换行符\n。

一般情况下，用换行符作为分隔符是没问题的，因为一行数据就代表一条记录。

当有特殊情况时，可以通过给RS赋值来改变分隔符。

比如：

	RS=""

上面将记录分隔符定义为空行。

awk会将多个连续的空白行看做一个单一的记录分隔行，awk也会忽略文件开头和末尾处的空白行。

### 4.记录和字段的引用

在awk中，用户可以使用系统变量来**引用**数据文件中的记录和字段。

如果想单独引用某个具体的字段，可以是使用系统变量$n来实现，例如：

	print $1, $2+$3+$4+$5

**Note**：对于用户来说，变量$0并不是只读的，用户可以自己把数据存储到$0变量中，awk仍然会自动分隔成多个字段。

## 4.运算符和表达式

### 1.算术运算符

awk支持的算术运算符
|运算符|说明|举例|
|------|----|----|
|+|加法运算|1+2表示计算1和2的和|
|-|减法运算|2-1表示计算2和1的差|
|\\*|乘法运算|2*5表示计算2和5的乘积|
|/|除法运算|6/3表示计算6和3的商|
|%|求模运算|5%2表示计算5和2的余数|
|^|指数运算|2^3表示计算2的3次方|

### 2.赋值运算符

为了简便，不再列表格，赋值运算符包括一下几种：
* = 直接赋值
* +=
* -=
* *=
* /=
* %=
* ^=

例如：

	x=4
	x+=10
	x*=2
	x^=2

### 3.条件运算符

awk中的条件运算符只有一个，语法如下：

	expression?value1:value2

此为一个三目运算符，当表达式expression的值为真时，返回值为value1，否则返回值为value2。

### 4.逻辑运算符

awk支持三种逻辑运算符，分别为逻辑与、逻辑或和逻辑非。

符号分别为：&& || ！

### 5.关系运算符

awk常用的关系运算符有：
* \>
* <
* \>=
* <=
* ==
* !=
* ~
* !~

其中，最后两个运算符比较特殊，是awk所特有的，分别为匹配运算符和不匹配运算符。

语法如下：

	A ~ B
	A !~ B

A表示一个字符串，B表示一个正则表达式，匹配运算符判断字符串A中是否**含有**符合正则表达式B所表达的字符串；不匹配字符串表示字符串A中是否**不含有**符合正则表达式B所表达的子字符串。

### 6.其他运算符

awk还支持一些其他的运算符，比如正号+、负号-、自增++以及自减--等。

这些运算符的使用方法与其他语言中的使用方法完全相同。

在awk中，各运算符的优先级与其他的程序设计语言相同。

## 5.函数

awk本身提供了许多系统函数，例如字符串函数以及算术函数。

另外，用户还可以自定义函数。

### 1.字符串函数

一些常用的字符串函数：

#### 1.index(string1,string2)

该函数用来定位字符串2在字符串1中出现的位置。

如果出现多次，就返回第一次出现的位置，如果string1不包含string2，则返回0.

该函数区分字母的大小写。

#### 2.length(string)

返回字符串string的长度


#### 3.match(string,regexp)

第一个参数为字符串，第二个参数为正则表达式。

该函数的功能是在字符串string中搜索匹配正则表达式的子串。

用户可以通过系统变量RSTART和RLENGHT来获得相关的返回值。

* RSTART：正则表达式匹配的子串在父串中出现的位置，若匹配不成功，则返回-1
* RLENGHT：正则表达式匹配的子串的长度

#### 4.split(string,array,seperator)

该函数的功能是将一个字符串根据指定的分隔符拆分成一个数组。

第一个参数是要拆分的字符串，第二个参数是用来**存储**拆分结果的数组，第三个参数用来指定分隔符。

#### 5.sub(regexp,replacement,string)和gsub(regexp,replacement,string)

这两个函数的功能都是替换字符串中的子串。

区别在于前者只替换第一次出现的子串，而后者替换所有的子串。

第一个参数为正则表达式，表示匹配规则；第二个参数是用来替换的字符串；第三个参数是将要被处理的字符串。

一种神奇的用法：如果第二个参数为空串，则相当于将匹配的子串删除。

#### 6.substr(string,start,[length])

该函数的功能是截取指定长度的子串。

第一个参数为父串；第二个参数表示子串开始截取的位置；第三个参数表示要截取的长度。

如果第三个参数被省略，则表示从start开始，一直到父串结束，进行截取。

### 2.算术函数

awk提供了基本的执行算术运算的函数，包括：

|函数|说明|
|----|----|
|int(x)|返回x的整数部分|
|sqrt(x)|返回x的平方根|
|exp(x)|返回e的x次方|
|log(x)|返回以e为底的对数值|
|sin(x)|返回x的正弦值，并且x为弧度值|
|cos(x)|同上|
|rand()|返回介于0和1之间的随机数|
|srand([x])|以x为种子返回一个随机数|

## 6.数组

### 1.数组的定义和赋值

数组是用来存储一组相互关联的数据的结构体。

事实上，awk没有提供数组定义的语句，当用户为数组第一个元素赋值时，awk便会自动创建该数组。

**Note**：awk的数组下标从1开始，并且数组名区分大小写。awk也支持关联数组，所谓关联数组，就是指以字符串作为下标的数组。

值得注意的是，awk数组可以存储任何简单类型的数据，甚至在同一个数组中，各个元素的类型也可以是不同的。

数组元素赋值语句如下：

	array[n]=value

用户可以使用以下语句来引用数组：

	array[n]

在同一个数组中，可以混合使用整数下标和字符串下标，另外，也可以将字符串、整数以及浮点数的数据赋给同一个数组的不同元素。

例如：

	arr[1]="Tim"
	arr["a"]=21
	arr[3]=3.1415
	arr[4]=5


### 2.遍历数组

遍历数组，就是把数组的元素依次输出。

用户必须事先知道数组的长度。在awk中，数组的长度可以使用length()函数获得。

用户可以使用两种方法遍历数组：
1. 使用循环结构来实现数组的遍历

2. 使用awk提供的哟中更为便捷的机制

	for (n in array){
		print array[n]
	}

但是，第二种方法存在一种弊端，即数组元素并不是按照顺序输出的。因为在这种方式中，数组元素的下标默认是无序的。

## 7.流程控制

awk是一种**程序设计语言**，awk支持程序的流程控制，包括条件判断、循环、continue、break以及exit等。

### 1.if语句

if语句的功能是根据用户给定的条件来决定执行哪个分支。

语法如下：

	if (expression)
	{
		statement1
		statement2
	}
	else
	{
		statement3
		statement4
	}

其中else分支可以省略。另外，if-else还可以嵌套。

### 2.while语句

语法如下：

	while (expression)
	{
		statement1
		statement2
	}

### 3.do-while语句

语法如下：

	do
	{
		statement1
		statement2
	}while(expression)

### 4.for语句

for循环语句通常用在循环次数已知的场合中，语法如下：

	for (expression1;expression2;expression3)
	{
		statement1
		statement2
	}

### 5.break语句

用户通过使用break语句在适当的时候退出循环。

### 6.continue语句

跳过循环体中尚未执行的语句，开始下一次循环。

### 7.next语句

next语句的功能与continue语句功能相似，但是二者的使用场景不同。

next语句并不是用在循环体中，而是作用于整个awk程序中。

当awk程序执行时，遇到next语句，则该语句后面的所有的程序语句都被忽略，包括其他的模式，以及对应的操作。

awk会继续读取下一行数据，并且从第一个模式及其操作开始执行。


### 8.exit语句

exit语句的功能是终止awk程序的执行。


## 8.awk程序的格式化输出

### 1.基本print语句

语法如下：

	print string1,string2,……

参数string1、string2都是要输出的数据，各个参数之间用逗号隔开。

在输出的时候，print语句会自动使用空格将各个参数值隔开。
另外，print语句会在输出的末尾自动加上换行符。


### 2.格式化输出printf语句

awk提供了printf()函数来实现字符串的格式化。该函数的功能和语法对C语言中的printf()函数基本相同，语法如下：

	printf(format,[arguments])

第一个参数是用来描述输出格式的字符串，通常以**引号括起来**的字符串常量的形式提供。

第二个参数列表是用来显示的数据，各个参数之间用逗号隔开。

格式化字符串的语法如下：

	%format

常用的格式化说明符有：
|描述符|说明|
|------|----|
|c|ASCII字符|
|d|十进制整数|
|e|浮点格式|
|s|字符串|
|%|百分号本身|

### 3.使用sprintf()函数生成格式化字符串

该函数只是以**字符串**的形式**返回格式化结果**，并不输出到标准输出设备。


## 9.awk的程序与Shell的交互

awk提供了与Shell命令交互的能力，从而可以使用户在awk程序中使用系统资源。

awk通过两种机制来实现这种交互功能：

* 管道
* system函数

### 1.通过“管道”实现与Shell的交互

用户可以很容易的在awk程序中使用操作系统资源，包括：
* 在程序中调用Shell命令处理程序中的数据
* 在awk程序中获取Shell命令的执行结果

awk提供了**管道**这种数据的双向交互。

**Note**：awk的管道和UNIX/Linux的管道概念不同。

### 2.通过system函数实现与Shell的交互

语法如下：

	system(command)

参数command表示要执行的Shell命令。

与管道相比，system函数有很多的局限性，比如：
* 不能在awk程序中直接获取Shell命令的执行结果，可以通过重定向将结果存在一个临时文件中，然后在awk程序中读取该文件的内容
* 也不能直接将awk程序中的数据传递给Shell命令来处理

第12章 文件的操作
===============

## 1.文件

### 1.列出文件

Linux提供了ls命令来列出某个目录的内容，其基本语法如下：

	ls [option]…… [file]……

option表示ls命令的选项，file参数表示文件名。

用户可以使用

	ls -l

命令来显示出更详细的信息，在输出的结果中：
* 第1列为文件的文件类型和访问权限，第1个字符为文件的类型，若为常规文件，则使用一个连字符-
* 第2列为文件的硬链接数
* 第3列为文件的所有者
* 第4列为文件的所有者所属的用户组
* 第5列为文件的大小
* 第6列为文件的最后访问时间
* 第7列为文件名

如果想要列出所有的文件，包括隐藏文件，使用：

	ls -la
	
### 2.文件的类型

文件的类型大致分为3类：
* 普通文件
	* 文本文件
	* 二进制文件
* 目录
* 伪文件
	* 特殊文件
	* 命名通道
	* proc文件

#### 1.普通文件

普通文件，一般称为常规文件或者一般文件。
普通文件，可以分为文本文件和二进制文件两种类型。

1. 文本文件：通常用来存储文本数据，例如纯文本、Shell脚本、源代码、配置文件、HTML文档等。文本文件包含的数据由可显示字符，例如字母、数字、标点符号、空格及制表符组成。

2. 二进制文件既包含可显示字符，也不包括可显示字符。这种类型的文件只有在执行或者由其他的应用程序解释时才有意义。

#### 2.目录

目录也是一种文件，其也存储在某些存储设备上面，但是目录本身不存储具体的用户数据。

目录的作用是**组织**和**访问**其他文件。

UNIX或者Linux系统中的**常规命令**通常放在/usr/bin目录中，而与系统有关的命令通常放在/usr/sbin目录中。

每个子目录和文件都在其父目录中拥有一条记录，该记录包含一下几个方面：
* 文件名
* 文件或者目录的唯一标识符（即inode节点）

#### 3.伪文件

伪文件和普通文件、目录不同，其不是用来存储数据的。

因此，这些文件不占用磁盘空间。

伪文件的目的是提供一种服务，通过这种服务，系统可以像操作普通文件一样来访问这些伪文件**所代表的对象**。

伪文件包括：
1. 设备文件：是物理设备在系统中的内部表示。
2. 命名管道：用户可以将一个命令的输出连接到另外一个命令的输入上面。
3. proc文件：它允许访问内核中的信息。

### 3.文件的权限

文件的权限用9个字符来表示，每3个字符表示一组：
* r：代表读取权限
* w：代表写入权限
* x：代表执行权限

前三组表示文件所有者的权限；中间三组表示文件所有者所在用户组的权限；后三组表示其他用户的权限。

**Note**：文件的用户组权限并不适用于文件的所有者。文件的所有者有单独的文件权限。


## 2.查找文件

Linux提供了几个关于文件搜索的命令，例如：locate、whereis以及find等。

### 1.find命令以及语法

find命令的功能非常强大，可以根据不同的标准搜索任何文件，并且可以在任何位置搜索。当find搜索完成后，可以以多种不同的方式来处理搜索结果。

find命令的基本思想：
	
	搜索一个或者多个目录树，根据用户指定的测试条件，查找符合特定标准的文件。当查找完成之后，find命令将对查找到的文件执行指定的操作。

在使用find命令时，用户常提供3种信息：
* 要搜索的路径
* 测试条件
* 操作

find命令的基本语法如下：

	find path test action

* path表示要搜索的路径，可以同时指定多个路径，路径之间用空格隔开
* test表示测试条件，可以同时指定多个测试条件，用空格隔开
* action表示对于搜索结果要执行的操作，可以指定多个操作，用空格隔开

find命令的工作流程：

1. 搜索所有用户指定的路径，包括所有的子目录
2. 对于遇到的每个文件，检查是否符合用户指定的操作。在该步骤中，所有符合条件的文件形成一个列表
3. 对于结果列表中的文件，执行用户指定的操作

### 3.find命令：测试

测试条件可以分为3组：
* 文件名
	* -name pattern			 表示包含指定匹配模式的文件名
	* -iname pattern		 同上，但不区分大小写
* 文件的特征
	* -type					 指定文件类型，f表示普通文件，d表示目录
	* -perm mode			 匹配权限被设置为mode的文件
	* -group groupid		 匹配所有者所在的用户组为指定id的文件	 
	* -user userid			 匹配所有者为指定id的文件
	* -size size			 匹配大小为size的文件
	* empty					 匹配空文件
* 文件的访问及修改时间
	* -amin [-+]n		 	 文件最后一次访问时间，-n表示访问时间距今n分钟内，+n表示访问时间距今n分钟以前，n表示恰好n分钟						 
	* -atime [-+]n			 文件最后一次访问时间，只是时间单位为天
	* -cmin [-+]n			 文件最后一次状态改变时间，时间单位为分钟
	* -ctime [-+]n			 文件最后一次状态改变时间，时间单位为天
	* -mmin [-+]n			 文件最后一次修改时间，时间单位为分钟
	* -mtime [-+]n			 文件最后一次修改时间，时间单位为天

在-type选项中，除了f、d以外，还有：
* c：表示字符设备
* b：表示块设备
* p：表示管道
* l：表示链接

**Note**：在使用通配符的时候，一定要用单引号或者双引号将通配符引用起来是一个非常好的习惯，可以有效地避免Shell解释并应用其中的通配符。

### 4.find命令：使用!运算符对测试求反

!符号可以加在任何测试条件的前面，表示对其后的测试条件取反。

在使用!符号的时候，必须在!符号的左右各留一个空格，如此，find命令才会正确解释!运算符。

另外，为了避免Shell解释!运算符，用户需要在其两边用单引号或者反斜线将其括起来。

### 5.find命令：处理文件权限错误信息

Linux系统的权限非常严格。如果当前用户对于指定的目录没有访问权限，则find命令会给出一些错误信息。

在Shell程序中，应尽力避免这类错误消息的出现。

实际中，find命令的错误消息是写入到标准错误的，一般是输出到屏幕上。

因此，用户可通过标准错误重定向到/dev/null来达到将错误消息直接丢弃的目的。

其中，/dev/null是一个空设备，任何写入到该设备的数据都将被直接丢弃。

例如：

	find / -name httpd.conf 2> /dev/null

其中，2是标准错误的文件描述符，>是重定向符。

### 6.find命令：动作

find命令中常用的动作有：

|动作|说明|
|----|----|
|-print|默认动作，将搜索结果写入到标准输出|
|-fprint file|将搜索结果写入到文件file|
|-ls|以详细格式显示搜索结果|
|-fls file|将搜索结果写入到文件file|
|-delete|将搜索到的文件删除|
|-exec command {} \;|查找并执行命令，{}表示find搜索到的文件名|
|-ok command {} \;|查找并执行命令，但是需要用户确认|

其中，-exec使find命令对搜索结果中文件执行指定的find命令，相应的Shell语法为：

	'command' {} \;

command表示Shell命令，大括号{}表示搜索结果中的文件名，最后的分号表示命令的结束。

**Note**：最后的分号需要**反斜线**来转义。

-ok和-exec的效果相同，但是-ok以一种更安全的方式来执行。
因为，-exec在执行Shell命令的时候不会给出任何提示。


## 3.比较文件

Linux中最常用的两个比较文件的命令：command、diff。

### 1.使用comm比较文件

comm命令的作用是比较两个**有序**的文件：
	
	comm [option]…… file1 file2

option表示comm命令的有关选项：
* -1：不显示第1个文件中独有的文本行
* -2：不显示第2个文件中独有的文本行
* -3：不显示两个文件中共同的文本行
* --check-order：检查参与比较的两个文件是否已经排序
* --nocheck-order：不检查参与比较的两个文件是否已经排序

默认情况下，comm命令会输出3列，这3列之间用制表符隔开：
1. 第1个文件独有的文本行
2. 第2个文件独有的文本行
3. 两个文件共有的文本行


### 2.使用diff比较文件

diff命令并不要求参与比较的文件是有序的。

diff不仅可以比较普通文件，还可以比较多个目录的内容的差异。

diff命令的基本语法为：

	diff [option]…… file1 file2

option的选项有：
* -c：输出包含上下文环境的格式
* -u：以统一格式显示文件的不同
* -y：以并列的方式显示文件的不同之处

diff命令使用非常简洁的语法来描述这两个文件的差异，文件内容的差异包括增加、删除、修改这3种操作。

diff分别用a、d和c这3个字符来表示以上三种操作。

## 4.文件描述符

### 1.什么是文件描述符

文件描述符是一个非负整数，它实际是一个索引值，指向内核为每个进程所维护的该进程打开文件的记录表。

当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。

文件的上下文：文件描述符及文件的相关信息（文件的打开模式、文件的位置类型、文件的初始类型等）称为文件的**上下文**。

习惯上：
* 标准输入的文件描述符是0
* 标准输出的文件描述符是1
* 标准错误的文件描述符是2

文件描述符从0开始，其最大值与当前系统中可以打开的最达文件数有关。

### 2.标准输入、标准输出和标准错误

当用户在Shell中执行命令的时候，每个进程都和3个文件描述有关，分别是：
* 标准输入
* 标准输出
* 标准错误

在默认情况下，这3个文件描述符都会自动创建。

1. 标准输入：文件描述符为0，默认为键盘，Shell命令的来源。
2. 标准输出：文件描述符为1，默认为显示器，显示Shell命令的执行结果。
3. 标准错误：文件描述符为2，默认为显示器，显示Shell命令的错误信息。


## 5.重定向

### 1.输出重定向（覆盖）

输出重定向是指将原本输出到标准输出\错误的数据输出到其他**文件**或者**设备**中。

输出重定向的操作符为大于号>，基本语法如下：

	command [n] > file

command表示Shell命令，大于号>为重定向操作符，file表示重定向的目标文件，n表示文件描述符（可以省略）。

**Note**：文件描述符与大于号之间**没有任何空格**，文件名与大于号之间的空格可有可无。

1. 如果目标文件不存在：重定向操作符>会先创建一个名称为file的空文件,然后向该文件中写入数据。
2. 如果目标文件存在：重定向操作符>会清空原始文件的内容，然后向该文件中写入数据。

对于标准输出和标准错误的同时重定向，有一种简洁的方法：

	ls -lz &> filelist

&符号代表标准输出和标准错误。


多个命令之间使用分号隔开，命令与**左右大括号**之间各保留一个空格，最后一条命令的**结尾**也要使用分号。

例如：

	{ date;who; } &> message

### 2.输出重定向（追加）

输出重定向除了覆盖模式之外，还有一种追加模式（追加在原文件的后面），操作符为两个连续的大于号>>。


基本语法如下：

	command [n]>> file


### 3.输入重定向

一般，Shell命令会从标准输入，即从键盘读取用户的输入数据。

但是Shell提供了另外一种读取用户输入的机制，即从文件中获取输入。

输入重定向的符号为小于号<，其基本语法如下：

	command [n]< file

文件描述符与小于号之间没有任何的空格。

输入重定向和输出重定向可以同时使用，表示从文件中读取数据，然后将执行结果输出到文件中，例如：

	grep Bae >demo.txt <students.txt

### 4.当前文档

输入重定向的另外一个用途是生成当前文档（here document）。

当前文档主要用在命令行中需要**多行输入**的情况。

基本语法如下：

	command << delimiter
	document
	delimiter

delimiter为分隔符，当Shell遇到重定向操作符<<时，会一直读取用户的输入，直到遇到某一行，其中包含指定的分隔符delimiter。

两个delimiter之间的行都属于命令cmd的标准输入。

**Note**：分隔符不能含有空格或者制表符。

例子：

	cat << eof
	This is a test file.
	There are two lines.
	eof


### 5.重定向两个文件描述符

用户可以通过重定向操作将（到一个文件描述符的输出）重定向到（另一个文件描述符），即复制一个文件描述符，其语法如下：

	n>&m

n和m都是文件描述符：

1. 当n=1,m=2时，文件描述符1成为文件描述符2的副本，所有的标准输出都被重定向到标准错误。
2. 当n=2,m=1时，文件描述符2成为文件描述符1的副本，所有的标准错误都被重定向到标准输出。


### 6.使用exec命令分配文件描述符

用户可以使用exec创建新的文件描述符，并将其绑定到文件或者另外一个文件描述符或者文件。

常用的重定向操作：


| 重定向 | 说明 |
-------|----
| exec 2>file | 将所有命令的标准错误重定向到文件file |
| exec n\<file | 以只读的方式打开文件file，且文件描述符为n |
| exec n>file | 以写的方式打开文件file，且文件描述符为n |
| exec n<>file | 以读写的方式打开文件file，且文件描述符为n |
| exec n>&- | 关闭文件描述符n |
| exec n>&m | 使文件描述符n成为文件描述符m的副本 |

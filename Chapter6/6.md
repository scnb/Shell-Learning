函数
===========

将一些相对独立的代码变成函数，可以提高程序的可读性和重用，避免重复编写大量相同的代码。

## 1.函数

### 1.什么是函数

所谓函数就是将一组功能相对独立的代码集中起来，形成一个代码块。

从本质上讲，函数是一个函数名到某个代码块的映射，即用户在定义了函数之后，就可以通过函数名来调用其所对应的一组代码。

虽然函数和Shell脚本并没有明显的差别，但是在执行的时候，函数和脚本还是有着本质上的区别。

* 对于一个单独的Shell脚本来说，在执行的时候，会为其创建一个新的Shell进程，来解释并执行脚本中的代码。当脚本执行完成，该Shell进程就会自动结束。

* 对于一个函数来说，系统并不会为其单独创建一个Shell进程，而是在调用者的Shell进程中直接解释并执行函数的代码。

### 2.函数的定义

在Shell中，用户可以通过两种语法来定义函数
   
    function_name ()
    {
        statement1
        statement2
        ……
    }

    function function_name ()
    {
        statement1
        statement2
        ……
    }

上面两种语法的区别仅在于，第二种中使用了function关键字。


### 3.函数的定义

当某个函数定义之后，用户就可以通过函数名来调用该函数。

在Shell中，函数调用的基本语法如下：

    function_name param1 param2 ……

当用户定义了一个函数之后，实际上该函数就成为一个合法的Shell命令。

**注意**：在定义函数时需要圆括号，而使用函数时无需圆括号。

### 4.函数链接

所谓函数链接，就是在某个Shell函数中调用另外一个函数的过程。

Shell允许用户函数的嵌套调用。

函数链接并不仅仅局限于在某个函数中调用另外一个函数，还可以进行：

* 多层嵌套调用
* 或者在某个函数总调用多个函数。

**Note**：在函数嵌套调用时，一定要注意函数定义的顺序和调用的顺序，一定要按照先定义，后调用的原则。

### 5.函数的返回值

Shell中的函数并没有准备要把函数中的某个运算结果作为函数的返回值来返回。

但是，在Shell中，存在着几种情况：

* 使用return语句来返回每个数值，但是，return语句只能返回某个0-255之间的整数值。函数中的return语句实际上是用来返回函数的退出状态码的。

* 在Shell中，另外一种更加优雅的方法是使用echo语句来返回需要的数据。

在函数中，用户将需要返回的数据写入到标准输出（stdin）中，使用echo语句完成。

由于用户可以将各种数据写入到标准输出，所以通过echo语句可以将各种数据作为返回值返回给函数调用者，而不仅仅局限与整数。

### 6.函数和别名

别名，就是一个Shell命令的缩写或者其他更容易记忆的名称。

用户可以使用alias命令来设置别名。

基本语法如下：

    alias name="command"

    删除别名可用unalias
    unalias name

    而用户定义的函数可用unset来删除
    unset function_name

name是要指定的别名，command则是原有的Shell命令，即真正要执行的命令。

函数和别名的相似之处：它们都是通过一个名称映射到一个或者一组命令。

* 函数是函数名到**一组**Shell命令的映射
* 别名则是别名到**一个**Shell命令的映射

函数和别名的不同之处在于别名的功能相对比较简单：
* 用户不能为一组命令指定别名
* 别名中不能通过系统变量操作参数列表


**Note**：在别名和同名命令同时存在的情况下，Shell会优先使用**用户定义**的命令。

### 6.再看全局变量和局部变量

默认情况下，除了与函数参数关联的特殊变量之外，其他所有的变量都有全局的有效范围。

在函数内部，如果没有使用local关键字进行修饰，那么函数章的变量也是全局变量。

无论在何处，赋值语句都会影响全局变量的值，并且，全局变量的值被改变之后，在整个脚本内都有效。

当某个程序中同时存在相同名称的全局变量和局部变量时，在函数内部，局部变量会屏蔽全局变量。

## 2.函数参数

通过参数，用户可以将想要函数处理的数据传递给函数。

### 1.含有参数的函数的调用方法

Shell的函数参数的语法比较特殊，Shell将脚本参数和函数参数做了统一化处理，即，Shell采用了相同的方法来处理脚本的参数和函数参数。

对于含有参数的函数，用户可以使用以下语法来调用：

    function_name arg1 arg2……

这些参数之间用空格隔开。

**Note**：如果某个参数中间有空格，则用单引号或双引号将其括起来。

### 2.获取函数参数的个数

在函数内部，用户也是通过位置变量来获取参数的值。

用户还可以通过系统变量$#来获取参数的个数，这一点与Shell脚本参数一样。

### 3.通过位置变量接受参数值

用户可以在Shell函数中使用**位置变量**来获取参数值。

$0表示脚本名称，$1表示第一个参数，$2表示第二个参数……

### 4.移动位置参数

在Shell脚本中，用户可以通过使用shift命令来使得脚本的所有的位置参数向左移动一个位置，从而使得用户可以通过9以内的位置变量来获取超过9个的参数。

一种非常巧妙的方法：一次获取传递给函数的各个参数

    while (($# > 0))
    do
        echo "$1"
        shift
    done

shift命令会影响到$#的值，因为：shift命令将所有的参数向左移动一个位置，同时删除原来的第一个参数。

### 5.通过getopts接收函数参数

getopts是bash内置的一个命令，通过该命令，用户可以获取函数的选项以及参数值，或者是脚本的命令行选项以及参数值。

getopts命令的基本语法如下：

    getopts optstring  [args]

参数optstring包含一个可以为getopts命令识别的选项名称列表

在optstring中，如果某个选项名称的后面跟随者**冒号**，则表示该选项可以接收参数。

参数值将被保存到一个名称为$OPTARG的系统变量中，getopts命令会依次遍历每个选项，**项名称**将被保存到args变量中。

例如：

    while getopts "a:b:c" arg
    do
        case "$arg" in
            a)
                echo "a's argument is $OPTARG"
                ;;
            b)
                echo "b's argument is $OPTARG"
                ;;
            c)
                echo "c"
                ;;
            ?)
                echo "unknown argument."
                exit 1
                ;;
        esac
    done

当用户提供了-a和-b选项时，输出参数值。

而当用户提供-c选项时，只是简单的输出一个字符c


### 6.间接参数传递

所谓间接参数传递，是指通过间接变量的引用来实现函数参数的传递。

**间接变量**：某个变量的值又是另一个变量的变量名。

例如，在某个脚本中：

    var=name
    name=john

变量var的值恰好是另一个变量的名字。

对第二个变量的引用有两种方式：

    ${name}
    ${!var}

第一种是直接通过变量名来引用

第二种是通过变量名来间接的引用

在Shell中，变量的间接引用通常使用以下语法来实现：

    ${!var_name}

### 7.通过全局变量传递参数

因为全局变量的作用域是整个脚本，所以全局变量可以在函数及函数外部使用，这样就相当于起到了函数传递的作用。

明显的，这种做法有很大的危险性，应该尽量避免使用。

### 8.传递数组参数

严格地讲，Shell并不支持将数组作为参数传递给函数，但是用户仍然可以通过一些**变通的方法**实现数组参数的传递。

#### 1.将数组的元素展开，作为多个由空格隔开的参数传递给函数

例如：

    func()
    {
            ……
    }

    a=(a b c d)
    func "${a[@]}"


## 3.函数库文件

为了方便的重用某些功能，可以创建一些可重用的函数，这些函数可以单独的放在函数库文件中。

### 1.函数库文件的定义

创建一个函数库文件的过程类似于编写一个Shell脚本。

脚本与库文件之间的唯一区别是库文件之间通常只包括函数，而脚本中还以有变量的定义、可执行代码等。

为了方便管理，应该将所有的库文件单独放到一个目录中。

由于库函数文件是由主程序**载入并执行**的，所以用户无需拥有库文件的执行权限，只拥有读权限即可。

### 2.库函数文件的调用

在Shell中，载入库文件的命令为：.，即一个小圆点。

语法如下：

    . filename

注意，在小圆点和文件名之间一定要有一个**空格**。

库文件可以使用相对路径，也可以是用绝对路径。

当用户在使用库文件时，一定要在调用前将库文件载入。


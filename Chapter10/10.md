流编辑
=====

流编辑器——一种Shell提供的文本处理工具。

## 1.sed命令及其语法

sed命令就是将**一系列的编辑命令**应用于**一批文本**的理想工具。

### 1.sed命令以及语法

sed命令是一个非交互式的文本编辑器，它可以对来自文本文件，以及标准输入的文本进行编辑。

标准输入可以是来自键盘、文件重定向、字符串、变量或者是管道的文本。

sed命令的过程：

1.  从文件或者标准输入中一次读取一行数据
2.  将数据复制到缓冲区
3.  读取命令行或者脚本的编辑子命令
4.  对缓冲区中的文本进行编辑
5.  重复此过程，直到所有的文本行都处理完毕

sed命令编辑的文件是原始文件在缓冲区中的副本，所以编辑操作并不影响原来的文件，并且输出到屏幕。

要想将处理结果保存下来，可以使用重定向将文件保存到磁盘上的一个文件中。

**sed命令的基本语法如下**：

    sed [options] [script] [inputfile]

* options代表sed命令的选项

* script表示sed脚本文件，用户可以将一系列的sed命令写在一个脚本文件中

* inputfile表示输入文本文件，如果没有指定输入文件，则从标准输入中读取

**特别强调**一下：-n选项。如果用户没有指定该选项，则缓冲区中的内容会自动写到标准输出。如果用户指定了该选项，则sed命令不会输出任何内容，而是直接读取下一行的数据。

### 2.sed命令的工作方式

用户可以通过3种方式来使用sed命令：

在命令行直接执行sed命令

    sed [options] commands inputfile

将sed操作写入脚本文件

    sed [options] -f script inputfile

将sed的操作写入文件，将脚本文件的执行权限授予用户

    ./script inputfile

上面，script代表保存sed命令的脚本文件，在其第一行应该写上

    #! /bin/sed

来执行该脚本的解释器。

### 3.使用行号定位文本行

一个完整的sed命令由**定位参数**和**编辑命令**两部分组成。

通过**定位参数**，用户可以对特定的文本行进行操作。

sed命令提供了两种方式来实现文本行的定位：

* 行号定位
* 正则表达式定位

#### 1.定位某个特定的行

语法如下：
    
    x

x是一个整数，代表特定的文本行的行号。

#### 2.定位某段连续的行

    x,y

x表示起始的行号，y表示终止的行号，该语法表示指定从x开始到y行结束的所有文本行。

#### 3.指定起始行和步长

某些情况下，用户可能需要具有特定间隔的文本行，例如奇数行、偶数行或者每隔3行等。

语法：

    first~step

first和step都是整数，first表示起始行，step表示行号增长的步长。

例如：

    指定奇数行
    0~2
    指定偶数行
    1~2

#### 4.指定文件的第一行和最后一行

指定文件的第一行：
    1

指定文件的最后一行，sed命令专门提供了一个操作符$

    $

#### 5.指定某行后面的几行

用户可以使用相对定位的方法来指定行：

    x,+n

比如：

    2,+5

表示从第2行以及后面的5行

### 4.使用正则表达式定位文本行

sed命令中，正则表达式的语法如下：

    /regexp/

常用的sed命令中的正则表达式元字符与之前的正则表达式元字符基本相同。

## 2.sed命令的常用操作

sed命令的一个组成部分就是编辑命令。

常用的编辑命令有：打印、插入、删除以及替换等。

### 1.sed编辑命令基本语法

sed命令的基本语法：

    [address1[,address2]] command [argument]

address1和address2都称为位置参数，其中位置参数有两种形式：行号和正则表达式。并且两者可以混用。

位置参数的作用是：限制sed编辑命令所影响的文本行的范围。

* sed命令没有提供位置参数：对所有文本行执行编辑操作
* 只有一个位置参数：只对符合指定位置的文本进行操作
* 有两个位置参数：对从address1开始到address2结束的文本行进行操作

command表示sed所提供的子命令，用来实现编辑操作。

argument表示子命令的参数。

### 2.选择文本

在sed命令中，选择文本行主要通过位置参数来完成。

基本语法如下：
    
    [address1[,addres2]] p

address1和address2都是位置参数，用来限定文本行的位置范围，p表示将缓冲区中的文本行执行输出操作，即打印（print）。

sed命令的**缓冲区**又称为**模式空间**（Pattern Space）

几个实际的用法：

    result=`sed -n '/^20020017/ p' students.txt`
    输出含有以2开头，紧跟着是0020017的字符串的文本行
    sed -n '1 p' students.txt
    输出第一行
    sed -n '$ p' students.txt
    输出最后一行
    sed -n '1~2 p' students.txt
    输出奇数行
    sed -n '/abdul/,5 p' students.txt
    表示从含有字符串"abdul"的文本行开始，到第五行结束

### 3.替换文本

使用sed命令，可以方便的对文本文件中指定的文本进行替换操作，要使用s子命令。

语法如下：

    [address1[ ,address2]] s/pattern/replacement/[flag]

address1和address2与前面讲的一样，都是位置参数。

通常位置参数会被省略，表示在所有的文本行中进行替换，其语法如下：

    s/pattern/replacement/[flag]

* s表示执行替换（substitute操作）
* pattern为使用正则表达式表示的匹配模式
* replacement为用来替换的由一般字符组成的字符串
* flag为替换标志

在s命令中，各个参数之间并不一定要使用斜线/分隔，还可以使用除空格及换行符之外的其他任意的字符。

**Note**：s命令会将紧跟在后面的那个字符作为参数分隔符。

例如：

    result=`sed 's:<[^>]*>::g' html.txt'
    result=`sed 's;<[^>]*>;;g' html.txt'

如果替换字符串中含有字符&或反斜线加上数字\n，则表示引用字符串。

&符号表示引用匹配的模式，即在某个文本行中与模式相匹配的那部分子串，而\n表示第n个由圆括号括起来的子串。

例如：

    result=`sed 's/string/long &/' demo1.txt`

其中，demo1.txt中的内容是：This is a string.

所上面的语句会用long string来替换string。

\n的例子如下：

    result=`sed 's/\(This\) \(is\) \(a\) \(string\)/\2\1\3\4/' demo1.txt`

上面的语句中表示将四个子串重排列。\2表示对第二个子串的引用，\1表示对第一个子串的引用。

上面语句的输出结果为：

    isthisastring

**Note**：在使用\n的形式引用模式的子串时，不能定义9个以上的字符，n的值为1~9。

### 4.删除文本

sed提供了d子命令来实现文本行的删除(delete)。

语法如下：

    [address1[ ,address2]] d

如果没有提供位置参数，则表示删除文本文件中的所有的行。

在执行删除操作时，sed命令会首先读取一行文本到缓冲区，然后将符合位置参数的文本行删除，接着读取并处理下一行。

几个示例：

    result=`sed '1,4 d' students.txt`

    result=`sed '1~2 d' students.txt`

    result=`sed '^$ d' students.txt`    删除空白行

### 5.追加文本

追加文本，是指将某些文本插入到某个位置的后面。

sed提供了a子命令来实现文本的追加（append），基本语法如下：

    [address1] a string

子命令a最多只能使用一个位置参数，参数string表示将要追加的文本。

a子命令会将string插入到address1所表示的位置后面。

### 6.插入文本

插入文本，就是将某写文本插入到某个位置的前面。

语法如下：

    [address1] i string



## 3.组合命令

使用组合命令，则可以在一条sed命令中将这些操作完成。

### 1.使用-e选项执行多个子命令

-e选项可以使sed将跟在其后面的字符串作为子命令执行。

例如：

    result=`sed -n -e 's/eE/g' -e '2,3 p' students.txt`

先使用-s命令把e替换成E，然后在用-p命令输出第2,3行。

并且第二个子命令输出的是第一个子命令处理后的结果。因为sed是一个行编辑工具，所有的子命令都是对缓冲区中的数据进行处理的。

### 2.使用分号执行多个子命令

使用分号将各个子命令隔开，语法如下：

    sed -e 'command1;command2……' filename

例如：

    result=`sed -e 's/e/E/g;2 i 200100001   Ellen' students.txt`

### 3.对一个地址使用多个子命令

语法如下：

    address{
        command1
        command2
        ……
    }

这些子命令使用大括号括起来，在大括号中的每个子命令，都允许有自己的位置参数。

还可以将所有的子命令写在一行中：

    [address] {commadn1;command2;……}

例如：

    result=`sed -n '1,5 {
        s/e/E/g
        s/a/A/g
        2 i 201303009   Tom
        p
    }' students.txt`

在第四行中，i命令拥有自己的位置参数

### 4.sed脚本文件

sed提供了-f选项，通过这个选项，sed命令，可以从指定的脚本文件中读取子命令，然后对每个文本行依次执行各个子命令。

语法如下：

    sed -f script

script表示sed脚本文件。

sed脚本的语法比较简单，将各个子命令依次列出来，不必使用引号。

如果将多条子命令写在同一行中，需要使用分号将其隔开。

### 可执行脚本

将所有的命令都写在一个脚本文件中，然后赋予该脚本文件可执行权限，如此，用户就不需要再在命令行中调用sed命令，而是直接执行该脚本文件。

**Note**：要在第一行指定解释器：

    #! /bin/sed -f

